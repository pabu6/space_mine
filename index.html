<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<title>å®‡å®™æ¢æŸ»ãƒã‚¤ãƒ³ã‚¹ã‚¤ãƒ¼ãƒ‘ãƒ¼</title>

<style>
:root{--cell-size:36px;}
html,body{height:100%; overflow:hidden;}
body{
  margin:0;
  font-family:sans-serif;
  background:url("space.jpg") center/cover no-repeat fixed;
  color:#fff;

  user-select:none;
  -webkit-user-select:none;
  -webkit-touch-callout:none;
  touch-action:manipulation;
}

/* ======================
   ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
====================== */
#container{ display:flex; height:100vh; }

@media(min-width:768px){
  #container{ justify-content:center; align-items:center; gap:32px; }
  :root{--cell-size:48px;}
}

@media(max-width:767px){
  :root{--cell-size:min(9vw,38px);}
  #container{
    flex-direction:column;
    align-items:center;
    padding-top:56px;
    gap:10px;
    box-sizing:border-box;
  }
  #side{ order:1; width:92vw; padding:10px; }
  #game{ order:2; width:92vw; padding:8px; }
  #explorer{ width:58vw; max-width:300px; }
}

/* ======================
   ä¸Šéƒ¨ãƒœã‚¿ãƒ³ï¼ˆã‚¹ãƒãƒ›ï¼‰
====================== */
#topButtons{display:none;}
@media(max-width:767px){
  #topButtons{
    position:fixed; top:0; left:0;
    width:100%; height:48px;
    background:rgba(5,5,20,.9);
    display:flex;
    justify-content:center;
    align-items:center;
    gap:12px;
    z-index:999;
    border-bottom:1px solid #111144;
  }
}

/* ======================
   ã‚²ãƒ¼ãƒ ç›¤
====================== */
#game{
  background:rgba(0,0,20,.6);
  border-radius:6px;
  position:relative;
  transition:box-shadow .2s, outline .2s, transform .2s;
}

/* 1æ®µéšç›®ï¼ˆæ®‹ã‚Š10ä»¥ä¸‹ï¼‰ï¼šè–„ã„ç‚¹æ»… */
#game.stage1{ animation:boardStage1 .9s infinite; }
@keyframes boardStage1{
  0%,100%{filter:brightness(.55);}
  50%{filter:brightness(.95);}
}

/* 2æ®µéšç›®ï¼ˆæ®‹ã‚Š3ä»¥ä¸‹ï¼‰ï¼šé»„è‰²æ ãƒã‚«ãƒã‚« */
#game.stage2{
  outline:3px solid rgba(255,215,0,.95);
  box-shadow:0 0 22px rgba(255,215,0,.65);
  animation:stage2Blink .28s infinite;
}
@keyframes stage2Blink{
  0%,100%{filter:brightness(.85) contrast(1.1);}
  50%{filter:brightness(1.35) contrast(1.35);}
}

/* 3æ®µéšç›®ï¼ˆæ®‹ã‚Š1ï¼‰ï¼šèµ¤æ ã§æºã‚Œã‚‹ */
#game.stage3{
  outline:4px solid rgba(255,60,60,.98);
  box-shadow:0 0 34px rgba(255,60,60,.75);
  animation:stage3Shake .16s infinite;
}
@keyframes stage3Shake{
  0%{transform:translate(0,0) rotate(0deg) scale(1.01); filter:brightness(1.05) contrast(1.25);}
  25%{transform:translate(1px,-1px) rotate(-0.4deg) scale(1.02); filter:brightness(1.2) contrast(1.45);}
  50%{transform:translate(-1px,1px) rotate(0.4deg) scale(1.02); filter:brightness(1.35) contrast(1.6);}
  75%{transform:translate(1px,1px) rotate(-0.3deg) scale(1.02); filter:brightness(1.2) contrast(1.45);}
  100%{transform:translate(-1px,-1px) rotate(0.3deg) scale(1.01); filter:brightness(1.05) contrast(1.25);}
}

/* ãƒ©ã‚¹ãƒˆ1ãƒã‚¹ç…½ã‚Šãƒ†ãƒ­ãƒƒãƒ— */
#hype{
  position:fixed; inset:0;
  display:none;
  align-items:center; justify-content:center;
  pointer-events:none;
  z-index:2000;
}
#hype.show{display:flex;}
#hype .box{
  padding:14px 18px;
  background:rgba(0,0,0,.55);
  border:1px solid rgba(255,215,0,.65);
  border-radius:10px;
  color:gold;
  font-weight:900;
  letter-spacing:.08em;
  text-shadow:0 0 10px rgba(255,215,0,.75);
  animation:hypeInOut .9s ease-in-out;
}
@keyframes hypeInOut{
  0%{opacity:0; transform:translateY(10px) scale(.96);}
  25%{opacity:1; transform:translateY(0) scale(1);}
  100%{opacity:0; transform:translateY(-6px) scale(1.02);}
}

table{border-collapse:collapse; margin:auto;}
td{
  width:var(--cell-size);
  height:var(--cell-size);
  border:1px solid #111144;
  background:#1a1a3d;
  text-align:center;
  font-weight:bold;
  cursor:pointer;
  font-size:calc(var(--cell-size)*0.5);

  user-select:none;
  -webkit-user-select:none;
  -webkit-touch-callout:none;

  touch-action:manipulation;
}
td.open{background:#33334d;cursor:default;}
td.flag{background:#111144;color:#0f0;}
td.enemy{background:black url("asteroid.jpeg") center/cover no-repeat;}
td.alien{background:url("alien.jpeg") center/cover no-repeat;}

.num1{color:#66ccff;}
.num2{color:#33ff77;}
.num3{color:#ff6666;}
.num4{color:#cc66ff;}
.num5{color:#ffcc66;}
.num6{color:#00cccc;}
.num7{color:#aaaaaa;}
.num8{color:#ffffff;}

/* ======================
   ã‚µã‚¤ãƒ‰UI
====================== */
#side{
  background:rgba(5,5,20,.7);
  padding:12px;
  text-align:center;
  border-radius:8px;
}
#explorer{width:min(300px,90vw);}
#explorer.captured{filter:grayscale(40%) brightness(.8);}
#explorer.perfect{
  border:6px solid gold;
  border-radius:14px;
  box-shadow:0 0 30px gold;
}

#status{
  margin-top:8px;
  font-size:18px;
  font-weight:bold;
}
#status.clear{
  color:gold;
  text-shadow:0 0 8px gold;
}

/* ======================
   ãƒœã‚¿ãƒ³
====================== */
button{
  padding:8px 14px;
  font-size:14px;
  background:#1a1a3d;
  border:none;
  color:white;
  cursor:pointer;
}
#buttons{
  margin-top:8px;
  display:flex;
  gap:8px;
  justify-content:center;
}
@media(max-width:767px){
  #buttons{display:none;}
}
</style>
</head>

<body>
<div id="topButtons">
  <button id="restartTop">RESTART</button>
  <button id="bgmToggleTop">BGM OFF</button>
</div>

<div id="hype"><div class="box">ãƒ©ã‚¹ãƒˆ1ãƒã‚¹ï¼ï¼ï¼</div></div>

<div id="container">
  <div id="game"></div>

  <div id="side">
    <img id="explorer" src="explorer.jpeg" alt="explorer" />
    <div id="status">æ¢ç´¢é–‹å§‹ï¼</div>

    <div id="buttons">
      <button id="restart">RESTART</button>
      <button id="bgmToggle">BGM OFF</button>
    </div>
  </div>
</div>

<!-- AUDIO -->
<audio id="seOpen" src="open.mp3"></audio>
<audio id="seFlag" src="flag.mp3"></audio>
<audio id="seDeath" src="death.mp3"></audio>
<audio id="sePerfect" src="perfect.mp3"></audio>
<audio id="alienSound" src="alienSound.mp3"></audio>
<audio id="clear1" src="clear1.mp3"></audio>
<audio id="clear2" src="clear2.mp3"></audio>
<audio id="bgm" src="bgm.mp3" loop></audio>
<audio id="lastBgm" src="last.mp3" loop></audio>

<script>
/* =========================
   ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆã“ã®é€šã‚Šã«ä¿å­˜ã—ã¦ãã ã•ã„ï¼‰
   - é€šå¸¸: explorer.jpeg
   - ç…½ã‚Š1: hype1.jpeg  (æ®‹ã‚Š10ä»¥ä¸‹)
   - ç…½ã‚Š2: hype2.jpeg  (æ®‹ã‚Š3ä»¥ä¸‹)
   - ç…½ã‚Š3: hype3.jpeg  (æ®‹ã‚Š1)
   - ã‚¯ãƒªã‚¢: clear.jpeg
   - ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆ: perfect.jpeg
========================= */

const ROWS=9, COLS=9, ENEMIES=10;

/* è¡¨ç¤ºç”»åƒï¼ˆHTMLã¨åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ç½®ãæƒ³å®šï¼‰ */
const IMG_NORMAL   = "explorer.jpeg";
const IMG_HYPE1    = "hype1.jpeg";
const IMG_HYPE2    = "hype2.jpeg";
const IMG_HYPE3    = "hype3.jpeg";
const IMG_CLEAR    = "clear.jpeg";
const IMG_PERFECT  = "perfect.jpeg";
const IMG_DEATH    = "explorer.jpeg"; // æ­»äº¡æ™‚ã‚‚é€šå¸¸ç”»åƒã®ã¾ã¾ï¼ˆåˆ¥ã«ã™ã‚‹ãªã‚‰ã“ã“ã‚’å¤‰æ›´ï¼‰

const ZERO_LIMIT_TRIES = 1500;
const MAX_ZERO_CELLS = 8;
const EXTRA_RING_OPEN = 3;

let board=[], opened=[], flags=[];
let gameOver=false;
let usedFlag=false;
let started=false;

let lastMode=false;   // BGMåˆ‡æ›¿ç”¨ï¼ˆæ®‹ã‚Š<=10ï¼‰
let stageShown=0;     // 0/1/2/3

let alienPos=null;
let alienFound=false;

let halfShown=false;
let lastTenShown=false;

const game=document.getElementById("game");
const explorer=document.getElementById("explorer");
const statusEl=document.getElementById("status");
const hype=document.getElementById("hype");

const bgm=document.getElementById("bgm");
const lastBgm=document.getElementById("lastBgm");

const bgmToggle=document.getElementById("bgmToggle");
const bgmToggleTop=document.getElementById("bgmToggleTop");

const seOpen=document.getElementById("seOpen");
const seFlag=document.getElementById("seFlag");
const seDeath=document.getElementById("seDeath");
const sePerfect=document.getElementById("sePerfect");
const alienSound=document.getElementById("alienSound");
const clear1=document.getElementById("clear1");
const clear2=document.getElementById("clear2");

/* ===== ã‚µã‚¦ãƒ³ãƒ‰ ===== */
function play(se){
  if(!se) return;
  try{ se.currentTime=0; se.play().catch(()=>{}); }catch(e){}
}
function stopAllBgm(){ bgm.pause(); lastBgm.pause(); }
function setBgmButtonText(on){
  const t = on ? "BGM OFF" : "BGM ON";
  bgmToggle.textContent=t;
  bgmToggleTop.textContent=t;
}
function isAnyBgmPlaying(){ return (!bgm.paused) || (!lastBgm.paused); }
function startBgmIfPossible(){
  const target = lastMode ? lastBgm : bgm;
  target.play().then(()=>setBgmButtonText(true)).catch(()=>setBgmButtonText(false));
}
function toggleBGM(){
  if(isAnyBgmPlaying()){
    stopAllBgm(); setBgmButtonText(false);
  }else{
    const target = lastMode ? lastBgm : bgm;
    target.play().then(()=>setBgmButtonText(true)).catch(()=>setBgmButtonText(false));
  }
}
bgmToggle.onclick=toggleBGM;
bgmToggleTop.onclick=toggleBGM;

/* ã‚¹ãƒãƒ›è‡ªå‹•å†ç”Ÿåˆ¶é™å¯¾ç­– */
document.addEventListener("pointerdown", ()=>{
  if(!isAnyBgmPlaying()) startBgmIfPossible();
},{once:true});

/* å³ã‚¯ãƒªãƒƒã‚¯/é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼æŠ‘æ­¢ */
document.addEventListener("contextmenu", (e)=>e.preventDefault());

document.getElementById("restart").onclick=init;
document.getElementById("restartTop").onclick=init;

/* ===== util ===== */
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function inBounds(r,c){ return r>=0 && r<ROWS && c>=0 && c<COLS; }
function neighbors(r,c){
  const res=[];
  for(let dr=-1; dr<=1; dr++){
    for(let dc=-1; dc<=1; dc++){
      if(dr===0 && dc===0) continue;
      const nr=r+dr, nc=c+dc;
      if(inBounds(nr,nc)) res.push([nr,nc]);
    }
  }
  return res;
}
function countAdjEnemies(r,c){
  return neighbors(r,c).reduce((acc,[nr,nc])=>acc + (board[nr][nc]===-1 ? 1 : 0),0);
}
function computeNumbers(){
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(board[r][c]===-1) continue;
      board[r][c]=countAdjEnemies(r,c);
    }
  }
}
function countZeroCells(){
  let z=0;
  for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) if(board[r][c]===0) z++;
  return z;
}

/* ===== board ===== */
function placeEnemiesWithSafeZone(excludeR, excludeC){
  board = Array.from({length:ROWS},()=>Array(COLS).fill(0));

  const safe=new Set();
  safe.add(excludeR+","+excludeC);
  for(const [nr,nc] of neighbors(excludeR, excludeC)) safe.add(nr+","+nc);

  let placed=0;
  while(placed<ENEMIES){
    const r=Math.floor(Math.random()*ROWS);
    const c=Math.floor(Math.random()*COLS);
    if(board[r][c]===-1) continue;
    if(safe.has(r+","+c)) continue;
    board[r][c]=-1;
    placed++;
  }
  computeNumbers();
}
function generateBoard(excludeR, excludeC){
  let best=null, bestZero=999;
  for(let t=0; t<ZERO_LIMIT_TRIES; t++){
    placeEnemiesWithSafeZone(excludeR, excludeC);
    const z=countZeroCells();
    if(z<bestZero){
      bestZero=z;
      best=board.map(row=>row.slice());
      if(z<=MAX_ZERO_CELLS) break;
    }
  }
  board = best || board;
}

/* alien every game */
function placeAlien(excludeR, excludeC){
  const avoid=new Set();
  avoid.add(excludeR+","+excludeC);
  for(const [nr,nc] of neighbors(excludeR, excludeC)) avoid.add(nr+","+nc);

  const candidates=[];
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(board[r][c]===-1) continue;
      if(avoid.has(r+","+c)) continue;
      candidates.push({r,c});
    }
  }
  if(candidates.length===0){
    for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) if(board[r][c]!==-1) candidates.push({r,c});
  }
  alienPos = candidates[Math.floor(Math.random()*candidates.length)] || null;
  alienFound=false;
}

/* ===== state ===== */
function setExplorerImageByStage(stage){
  // gameOverä¸­ã¯åˆ¥å‡¦ç†ï¼ˆæ­»äº¡/ã‚¯ãƒªã‚¢ï¼‰ãªã®ã§ã“ã“ã¯é€šå¸¸ãƒ—ãƒ¬ã‚¤æ™‚å°‚ç”¨
  if(stage===0) explorer.src = IMG_NORMAL;
  if(stage===1) explorer.src = IMG_HYPE1;
  if(stage===2) explorer.src = IMG_HYPE2;
  if(stage===3) explorer.src = IMG_HYPE3;
}

function buildEmptyState(){
  board = Array.from({length:ROWS},()=>Array(COLS).fill(0));
  opened = Array.from({length:ROWS},()=>Array(COLS).fill(false));
  flags  = Array.from({length:ROWS},()=>Array(COLS).fill(false));

  gameOver=false;
  usedFlag=false;
  started=false;

  lastMode=false;
  stageShown=0;

  alienPos=null;
  alienFound=false;

  halfShown=false;
  lastTenShown=false;

  explorer.src = IMG_NORMAL;
  explorer.classList.remove("captured","perfect");

  statusEl.classList.remove("clear");
  statusEl.textContent="æ¢ç´¢é–‹å§‹ï¼";

  game.classList.remove("stage1","stage2","stage3");
  hype.classList.remove("show");

  stopAllBgm();
  startBgmIfPossible();
}

function init(){
  buildEmptyState();
  render();
}

/* ===== render ===== */
function render(){
  const table=document.createElement("table");

  for(let r=0;r<ROWS;r++){
    const tr=document.createElement("tr");
    for(let c=0;c<COLS;c++){
      const td=document.createElement("td");
      const isOpen=opened[r][c];
      const isFlag=flags[r][c];

      if(isOpen) td.classList.add("open");
      if(isFlag) td.classList.add("flag");

      if(isOpen && alienPos && alienPos.r===r && alienPos.c===c && alienFound){
        td.classList.add("alien");
        td.textContent="";
      }else if(isOpen){
        const v=board[r][c];
        if(v===-1){
          td.classList.add("enemy");
          td.textContent="";
        }else if(v===0){
          td.textContent="";
        }else{
          td.textContent=String(v);
          td.classList.add("num"+v);
        }
      }else{
        td.textContent = isFlag ? "ğŸš©" : "";
      }

      td.addEventListener("click", ()=> onOpen(r,c));
      td.addEventListener("contextmenu", (e)=>{ e.preventDefault(); onToggleFlag(r,c); });
      attachLongPress(td, ()=> onToggleFlag(r,c));

      tr.appendChild(td);
    }
    table.appendChild(tr);
  }

  game.innerHTML="";
  game.appendChild(table);

  updateProgressMessages();
  updateEndgameEffects(); // ã“ã“ã§æ®µéšã«å¿œã˜ã¦ç”»åƒã‚‚åˆ‡ã‚Šæ›¿ãˆã‚‹
}

/* ===== long press ===== */
function attachLongPress(el, fn){
  let timer=null;
  let moved=false;

  const start=()=>{
    if(gameOver) return;
    moved=false;
    timer=setTimeout(()=>{ timer=null; fn(); }, 450);
  };
  const cancel=()=>{ if(timer){ clearTimeout(timer); timer=null; } };

  el.addEventListener("touchstart", start, {passive:true});
  el.addEventListener("touchmove", ()=>{ moved=true; cancel(); }, {passive:true});
  el.addEventListener("touchend", ()=>{ if(!moved) cancel(); }, {passive:true});
  el.addEventListener("touchcancel", cancel, {passive:true});
}

/* ===== gameplay ===== */
function ensureStarted(firstR, firstC){
  if(started) return;
  started=true;
  generateBoard(firstR, firstC);
  placeAlien(firstR, firstC);
}

function openZeroAreaFullWithRing(sr, sc){
  const zeroSet=new Set();
  const ringSet=new Set();
  const q=[[sr,sc]];
  zeroSet.add(sr+","+sc);

  while(q.length){
    const [r,c]=q.shift();
    for(const [nr,nc] of neighbors(r,c)){
      if(board[nr][nc]===0){
        const key=nr+","+nc;
        if(!zeroSet.has(key)){
          zeroSet.add(key);
          q.push([nr,nc]);
        }
      }else if(board[nr][nc]>0){
        ringSet.add(nr+","+nc);
      }
    }
  }

  for(const key of zeroSet){
    const [r,c]=key.split(",").map(Number);
    if(!flags[r][c]) opened[r][c]=true;
  }
  for(const key of ringSet){
    const [r,c]=key.split(",").map(Number);
    if(!flags[r][c]) opened[r][c]=true;
  }

  // è¿½åŠ ã§å°‘ã—ã ã‘é–‹ãï¼ˆãƒªãƒ³ã‚°å¤–å´ã®æ•°å­—ã®ã¿ï¼‰
  const extraCandidates=new Set();
  for(const key of ringSet){
    const [r,c]=key.split(",").map(Number);
    for(const [nr,nc] of neighbors(r,c)){
      const k=nr+","+nc;
      if(!inBounds(nr,nc)) continue;
      if(zeroSet.has(k) || ringSet.has(k)) continue;
      if(opened[nr][nc] || flags[nr][nc]) continue;
      if(board[nr][nc] > 0) extraCandidates.add(k);
    }
  }
  const list=[...extraCandidates].map(s=>s.split(",").map(Number));
  shuffle(list);
  for(let i=0;i<Math.min(EXTRA_RING_OPEN, list.length); i++){
    const [r,c]=list[i];
    opened[r][c]=true;
  }
}

function onOpen(r,c){
  if(gameOver) return;
  if(flags[r][c]) return;

  ensureStarted(r,c);
  if(opened[r][c]) return;

  const isAlienCell = alienPos && alienPos.r===r && alienPos.c===c;

  if(board[r][c]===-1){
    opened[r][c]=true;
    revealAllEnemies();
    gameOver=true;

    explorer.src = IMG_DEATH;
    explorer.classList.add("captured");
    statusEl.textContent="ãƒ‰ã‚«ãƒ¼ãƒ³ãƒƒï¼ ä»»å‹™å¤±æ•—ï¼ï¼";
    play(seDeath);

    stopAllBgm();
    setBgmButtonText(false);

    render();
    return;
  }

  opened[r][c]=true;

  if(isAlienCell && !alienFound){
    alienFound=true;
    play(alienSound);
    statusEl.textContent="ã‚ã£ï¼ï¼ç«æ˜Ÿäººã ï¼ï¼";
  }

  if(board[r][c]===0){
    openZeroAreaFullWithRing(r,c);

    // å®‡å®™äººã¯è‡ªåˆ†ã§é–‹ã‘ãŸã„ï¼šè‡ªå‹•å±•é–‹ã§å‹æ‰‹ã«é–‹ã„ãŸã‚‰é–‰ã˜æˆ»ã™
    if(alienPos && !alienFound && opened[alienPos.r][alienPos.c]){
      opened[alienPos.r][alienPos.c]=false;
    }
  }

  play(seOpen);
  render();
  checkClear();
}

function onToggleFlag(r,c){
  if(gameOver) return;
  if(opened[r][c]) return;

  usedFlag=true;
  flags[r][c]=!flags[r][c];
  play(seFlag);
  render();
  checkClear();
}

function revealAllEnemies(){
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(board[r][c]===-1) opened[r][c]=true;
    }
  }
}

/* ===== progress messages ===== */
function remainingSafeCells(){
  let remain=0;
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(board[r][c]!==-1 && !opened[r][c]) remain++;
    }
  }
  return remain;
}
function countOpenedSafeCells(){
  let n=0;
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(board[r][c]!==-1 && opened[r][c]) n++;
    }
  }
  return n;
}
function totalSafeCells(){ return ROWS*COLS - ENEMIES; }

function updateProgressMessages(){
  if(!started || gameOver) return;

  const openedSafe=countOpenedSafeCells();
  const totalSafe=totalSafeCells();

  if(!halfShown && openedSafe >= Math.ceil(totalSafe/2)){
    halfShown=true;
    statusEl.textContent="ã‚„ã£ã¨åŠåˆ†ã ï¼";
  }

  const remain=remainingSafeCells();
  if(!lastTenShown && remain>0 && remain<10){
    lastTenShown=true;
    statusEl.textContent="ã‚ã¨å°‘ã—ï¼ï¼";
  }
}

/* ===== endgame effects (3 stages) ===== */
function showLastOneHypeOnce(){
  hype.classList.add("show");
  setTimeout(()=>hype.classList.remove("show"), 900);
}

function updateEndgameEffects(){
  if(!started || gameOver) return;

  const remain=remainingSafeCells();

  // ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¤å®š
  let stage=0;
  if(remain>0 && remain<=10) stage=1;
  if(remain>0 && remain<=3)  stage=2;
  if(remain===1)             stage=3;

  // ç›¤é¢ã‚¯ãƒ©ã‚¹æ›´æ–°
  game.classList.remove("stage1","stage2","stage3");
  if(stage===1) game.classList.add("stage1");
  if(stage===2) game.classList.add("stage2");
  if(stage===3) game.classList.add("stage3");

  // ç”»åƒåˆ‡ã‚Šæ›¿ãˆï¼ˆç…½ã‚Šæ®µéšï¼‰
  setExplorerImageByStage(stage);

  // BGMåˆ‡æ›¿ï¼ˆæ®‹ã‚Š<=10ï¼‰
  const shouldLast = stage>=1;
  if(shouldLast && !lastMode){
    lastMode=true;
    if(isAnyBgmPlaying()){
      bgm.pause();
      lastBgm.currentTime=0;
      lastBgm.play().catch(()=>{});
    }
  }
  if(!shouldLast && lastMode){
    lastMode=false;
    if(isAnyBgmPlaying()){
      lastBgm.pause();
      bgm.currentTime=0;
      bgm.play().catch(()=>{});
    }
  }

  // æ®µéšçªå…¥æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  if(stage > stageShown){
    stageShown = stage;
    if(stage===2){
      statusEl.textContent="æ€¥ãŒãªã„ã¨æƒ‘æ˜ŸãŒçˆ†ç™ºã™ã‚‹ï¼";
    }else if(stage===3){
      // 3æ®µéšç›®çªå…¥
      showLastOneHypeOnce();
      statusEl.textContent="æ—©ãè„±å‡ºã—ãªã„ã¨ã‰ã‰ã‰ã£ã£ï¼ï¼ï¼";
    }
  }

  // 3æ®µéšç›®ã¯ã€Œã‚‚ã†1ã¤ã®æ–‡è¨€ã€ã‚‚å‡ºã—ãŸã„è¦æœ›ãŒã‚ã£ãŸãŸã‚ã€äº¤äº’è¡¨ç¤º
  if(stage===3){
    const t = Date.now();
    statusEl.textContent = (Math.floor(t/1200)%2===0)
      ? "æ—©ãå®‡å®™èˆ¹ã«æˆ»ã‚‰ãªã„ã¨ï¼ï¼"
      : "æ—©ãè„±å‡ºã—ãªã„ã¨ã‰ã‰ã‰ã£ã£ï¼ï¼ï¼";
  }
}

/* ===== clear ===== */
function checkClear(){
  if(gameOver) return;
  if(!started) return;

  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(board[r][c]!==-1 && !opened[r][c]) return;
    }
  }

  gameOver=true;
  statusEl.textContent="ä»»å‹™æˆåŠŸï¼ï¼";
  statusEl.classList.add("clear");

  stopAllBgm();
  setBgmButtonText(false);

  if(!usedFlag){
    explorer.src = IMG_PERFECT;
    explorer.classList.add("perfect");
    play(sePerfect);
  }else{
    explorer.src = IMG_CLEAR;
    play(Math.random()<0.5 ? clear1 : clear2);
  }
}

init();
</script>
</body>
</html>