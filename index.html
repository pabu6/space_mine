<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<title>ÂÆáÂÆôÊé¢Êüª„Éû„Ç§„É≥„Çπ„Ç§„Éº„Éë„Éº</title>

<style>
:root{--cell-size:36px;}
html,body{height:100%; overflow:hidden;}
body{
  margin:0;
  font-family:sans-serif;
  background:url("space.jpg") center/cover no-repeat fixed;
  color:#fff;

  user-select:none;
  -webkit-user-select:none;
  -webkit-touch-callout:none;
  touch-action:manipulation;
}

#container{ display:flex; height:100vh; }

@media(min-width:768px){
  #container{ justify-content:center; align-items:center; gap:32px; }
  :root{--cell-size:48px;}
}

/* „Çπ„Éû„Éõ„Å†„ÅëÔºàPC„ÅØËß¶„Çâ„Å™„ÅÑÔºâ */
@media(max-width:767px){
  :root{
    --topbar-h:48px;
    --gap:6px;
    --side-pad:6px;
    --cell-size:min(9.2vw, 36px);
  }

  html,body{ height:100%; overflow:hidden; }

  #container{
    flex-direction:column;
    align-items:center;
    height:100vh;
    padding-top:calc(var(--topbar-h) + env(safe-area-inset-top, 0px));
    padding-bottom:env(safe-area-inset-bottom, 0px);
    gap:var(--gap);
    box-sizing:border-box;
  }

  #side{ order:1; width:94vw; padding:var(--side-pad); }

  #explorer{
    width:100%;
    max-width:94vw;
    height:28vh;
    max-height:280px;
    object-fit:contain;
    display:block;
    margin:0 auto;
    margin-top:-6px;
  }

  #status{
    margin-top:4px;
    font-size:15px;
    line-height:1.15;
  }

  #game{
    order:2;
    width:94vw;
    padding:6px;
    max-height:calc(
      100vh
      - (var(--topbar-h) + env(safe-area-inset-top, 0px))
      - env(safe-area-inset-bottom, 0px)
      - 28vh
      - 78px
    );
    overflow:hidden;
  }
}

/* ‰∏äÈÉ®„Éú„Çø„É≥Ôºà„Çπ„Éû„ÉõÔºâ */
#topButtons{display:none;}
@media(max-width:767px){
  #topButtons{
    position:fixed;
    top:env(safe-area-inset-top, 0px);
    left:0;
    width:100%;
    height:48px;
    background:rgba(5,5,20,.9);
    display:flex;
    justify-content:center;
    align-items:center;
    gap:12px;
    z-index:999;
    border-bottom:1px solid #111144;
  }
}

/* „Ç≤„Éº„É†Áõ§ */
#game{
  background:rgba(0,0,20,.6);
  border-radius:6px;
  position:relative;
  transition:box-shadow .2s, outline .2s, transform .2s;
}
#game.stage1{ animation:boardStage1 .9s infinite; }
@keyframes boardStage1{
  0%,100%{filter:brightness(.55);}
  50%{filter:brightness(.95);}
}
#game.stage2{
  outline:3px solid rgba(255,215,0,.95);
  box-shadow:0 0 22px rgba(255,215,0,.65);
  animation:stage2Blink .28s infinite;
}
@keyframes stage2Blink{
  0%,100%{filter:brightness(.85) contrast(1.1);}
  50%{filter:brightness(1.35) contrast(1.35);}
}
#game.stage3{
  outline:4px solid rgba(255,60,60,.98);
  box-shadow:0 0 34px rgba(255,60,60,.75);
  animation:stage3Blink .22s infinite;
}
@keyframes stage3Blink{
  0%,100%{filter:brightness(.85) contrast(1.15); transform:scale(1.01);}
  50%{filter:brightness(1.45) contrast(1.55); transform:scale(1.02);}
}

/* „É©„Çπ„Éà1„Éû„ÇπÁÖΩ„Çä„ÉÜ„É≠„ÉÉ„Éó */
#hype{
  position:fixed; inset:0;
  display:none;
  align-items:center; justify-content:center;
  pointer-events:none;
  z-index:2000;
}
#hype.show{display:flex;}
#hype .box{
  padding:14px 18px;
  background:rgba(0,0,0,.55);
  border:1px solid rgba(255,215,0,.65);
  border-radius:10px;
  color:gold;
  font-weight:900;
  letter-spacing:.08em;
  text-shadow:0 0 10px rgba(255,215,0,.75);
  animation:hypeInOut .9s ease-in-out;
}
@keyframes hypeInOut{
  0%{opacity:0; transform:translateY(10px) scale(.96);}
  25%{opacity:1; transform:translateY(0) scale(1);}
  100%{opacity:0; transform:translateY(-6px) scale(1.02);}
}

table{border-collapse:collapse; margin:auto;}
td{
  width:var(--cell-size);
  height:var(--cell-size);
  border:1px solid #111144;
  background:#1a1a3d;
  text-align:center;
  font-weight:bold;
  cursor:pointer;
  font-size:calc(var(--cell-size)*0.5);

  user-select:none;
  -webkit-user-select:none;
  -webkit-touch-callout:none;
  touch-action:manipulation;
}
td.open{background:#33334d;cursor:default;}
td.flag{background:#111144;color:#0f0;}
td.enemy{background:black url("asteroid.jpeg") center/cover no-repeat;}
td.alien{background:url("alien.jpeg") center/cover no-repeat;}

.num1{color:#66ccff;}
.num2{color:#33ff77;}
.num3{color:#ff6666;}
.num4{color:#cc66ff;}
.num5{color:#ffcc66;}
.num6{color:#00cccc;}
.num7{color:#aaaaaa;}
.num8{color:#ffffff;}

/* „Çµ„Ç§„ÉâUI */
#side{
  background:rgba(5,5,20,.7);
  padding:12px;
  text-align:center;
  border-radius:8px;
}
#explorer{width:min(300px,90vw);}
#explorer.captured{filter:grayscale(40%) brightness(.8);}
#explorer.perfect{
  border:6px solid gold;
  border-radius:14px;
  box-shadow:0 0 30px gold;
}

#status{
  margin-top:8px;
  font-size:18px;
  font-weight:bold;
}
#status.clear{
  color:gold;
  text-shadow:0 0 8px gold;
}

/* „Éú„Çø„É≥ */
button{
  padding:8px 14px;
  font-size:14px;
  background:#1a1a3d;
  border:none;
  color:white;
  cursor:pointer;
}
#buttons{
  margin-top:8px;
  display:flex;
  gap:8px;
  justify-content:center;
}
@media(max-width:767px){
  #buttons{display:none;}
}
</style>
</head>

<body>
<div id="topButtons">
  <button id="restartTop">RESTART</button>
  <button id="bgmToggleTop">BGM OFF</button>
</div>

<div id="hype"><div class="box" id="hypeText"></div></div>

<div id="container">
  <div id="game"></div>

  <div id="side">
    <img id="explorer" src="explorer.jpeg" alt="explorer" />
    <div id="status">Êé¢Á¥¢ÈñãÂßãÔºÅ</div>

    <div id="buttons">
      <button id="restart">RESTART</button>
      <button id="bgmToggle">BGM OFF</button>
    </div>
  </div>
</div>

<!-- AUDIO -->
<audio id="seOpen" src="open.mp3"></audio>
<audio id="seFlag" src="flag.mp3"></audio>
<audio id="seDeath" src="death.mp3"></audio>
<audio id="sePerfect" src="perfect.mp3"></audio>
<audio id="alienSound" src="alienSound.mp3"></audio>
<audio id="clear1" src="clear1.mp3"></audio>
<audio id="clear2" src="clear2.mp3"></audio>

<!-- PERFECTÂ∞ÇÁî®Èü≥Â£∞Ôºà‰øùÂ≠òÂêçÔºöperfectClear.mp3Ôºâ -->
<audio id="perfectClear" src="perfectClear.mp3"></audio>

<audio id="bgm" src="bgm.mp3" loop></audio>
<audio id="lastBgm" src="last.mp3" loop></audio>

<script>
const ROWS=9, COLS=9, ENEMIES=10;

const IMG_NORMAL   = "explorer.jpeg";
const IMG_HYPE1    = "hype1.jpeg";
const IMG_HYPE2    = "hype2.jpeg";
const IMG_HYPE3    = "hype3.jpeg";
const IMG_CLEAR    = "clear.jpeg";
const IMG_PERFECT  = "perfect.jpeg";
const IMG_DEATH    = "death.jpeg";

const EXTRA_RING_OPEN = 3;

let board=[], opened=[], flags=[];
let gameOver=false;
let usedFlag=false;
let started=false;

let lastMode=false;
let stageShown=0;

let alienPos=null;

const game=document.getElementById("game");
const explorer=document.getElementById("explorer");
const statusEl=document.getElementById("status");
const hype=document.getElementById("hype");
const hypeText=document.getElementById("hypeText");

const bgm=document.getElementById("bgm");
const lastBgm=document.getElementById("lastBgm");

const bgmToggle=document.getElementById("bgmToggle");
const bgmToggleTop=document.getElementById("bgmToggleTop");

const seOpen=document.getElementById("seOpen");
const seFlag=document.getElementById("seFlag");
const seDeath=document.getElementById("seDeath");
const sePerfect=document.getElementById("sePerfect");
const alienSound=document.getElementById("alienSound");
const clear1=document.getElementById("clear1");
const clear2=document.getElementById("clear2");
const perfectClear=document.getElementById("perfectClear");

/* Èü≥Èáè */
seOpen.volume=0.9;
seFlag.volume=0.9;
seDeath.volume=1.0;
alienSound.volume=1.0;
clear1.volume=1.0;
clear2.volume=1.0;
sePerfect.volume=1.0;
perfectClear.volume=1.0;

function play(se){
  if(!se) return;
  try{ se.currentTime=0; se.play().catch(()=>{}); }catch(e){}
}
function stopAllBgm(){ bgm.pause(); lastBgm.pause(); }

/* BGMÔºö1Âõû„Çø„ÉÉ„Éó„ÅßÁ∂ôÁ∂öÔºà„Åü„Å†„Åó„ÇØ„É™„Ç¢ÊôÇ„ÅØÊ≠¢„ÇÅ„ÇãÔºâ */
let bgmUnlocked=false;
let userBgmEnabled=true;

function setBgmButtonText(){
  const on = bgmUnlocked && userBgmEnabled;
  const t = on ? "BGM OFF" : "BGM ON";
  bgmToggle.textContent=t;
  bgmToggleTop.textContent=t;
}
function currentBgmEl(){ return lastMode ? lastBgm : bgm; }
function ensureBgmPlaying(){
  if(!bgmUnlocked || !userBgmEnabled) return;
  const target=currentBgmEl();
  if(!target.paused) return;
  if(target===bgm && !lastBgm.paused) lastBgm.pause();
  if(target===lastBgm && !bgm.paused) bgm.pause();
  target.play().catch(()=>{});
}
function toggleBGM(){
  userBgmEnabled=!userBgmEnabled;
  if(!userBgmEnabled) stopAllBgm();
  else ensureBgmPlaying();
  setBgmButtonText();
}
bgmToggle.onclick=toggleBGM;
bgmToggleTop.onclick=toggleBGM;

document.addEventListener("pointerdown", ()=>{
  bgmUnlocked=true;
  ensureBgmPlaying();
  setBgmButtonText();
},{once:true});

function switchBgmMode(toLast){
  if(lastMode===toLast) return;
  lastMode=toLast;
  ensureBgmPlaying();
}

/* ===== util ===== */
document.addEventListener("contextmenu", (e)=>e.preventDefault());
document.getElementById("restart").onclick=init;
document.getElementById("restartTop").onclick=init;

function inBounds(r,c){ return r>=0 && r<ROWS && c>=0 && c<COLS; }
function neighbors(r,c){
  const res=[];
  for(let dr=-1; dr<=1; dr++){
    for(let dc=-1; dc<=1; dc++){
      if(dr===0 && dc===0) continue;
      const nr=r+dr, nc=c+dc;
      if(inBounds(nr,nc)) res.push([nr,nc]);
    }
  }
  return res;
}
function countAdjEnemies(r,c){
  return neighbors(r,c).reduce((acc,[nr,nc])=>acc + (board[nr][nc]===-1 ? 1 : 0),0);
}
function computeNumbers(){
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(board[r][c]===-1) continue;
      board[r][c]=countAdjEnemies(r,c);
    }
  }
}
function remainingSafeCells(){
  let cnt=0;
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(board[r][c]!==-1 && !opened[r][c]) cnt++;
    }
  }
  return cnt;
}
function key(r,c){ return r+","+c; }
function isAlienCell(r,c){ return alienPos && alienPos[0]===r && alienPos[1]===c; }

/* ===== board ===== */
function placeEnemiesWithSafeZone(excludeR, excludeC){
  board = Array.from({length:ROWS},()=>Array(COLS).fill(0));

  const safe=new Set();
  safe.add(key(excludeR,excludeC));
  for(const [nr,nc] of neighbors(excludeR, excludeC)) safe.add(key(nr,nc));

  let placed=0;
  while(placed<ENEMIES){
    const r=Math.floor(Math.random()*ROWS);
    const c=Math.floor(Math.random()*COLS);
    if(safe.has(key(r,c))) continue;
    if(board[r][c]===-1) continue;
    board[r][c]=-1;
    placed++;
  }

  while(true){
    const r=Math.floor(Math.random()*ROWS);
    const c=Math.floor(Math.random()*COLS);
    if(safe.has(key(r,c))) continue;
    if(board[r][c]===-1) continue;
    alienPos=[r,c];
    break;
  }

  computeNumbers();
}

/* ===== render ===== */
function render(){
  const table=document.createElement("table");
  for(let r=0;r<ROWS;r++){
    const tr=document.createElement("tr");
    for(let c=0;c<COLS;c++){
      const td=document.createElement("td");
      td.dataset.r=r; td.dataset.c=c;

      td.addEventListener("click",(e)=>{
        e.preventDefault();
        if(gameOver) return;
        openCell(r,c);
      });

      td.addEventListener("contextmenu",(e)=>{
        e.preventDefault();
        if(gameOver) return;
        toggleFlag(r,c);
      });

      // „Çπ„Éû„ÉõÈï∑Êäº„ÅóÊóó
      let pressTimer=null;
      td.addEventListener("pointerdown",(e)=>{
        if(e.pointerType==="mouse") return;
        if(gameOver) return;
        pressTimer=setTimeout(()=>{
          toggleFlag(r,c);
          pressTimer=null;
        },380);
      });
      td.addEventListener("pointerup",()=>{ if(pressTimer){clearTimeout(pressTimer);pressTimer=null;} });
      td.addEventListener("pointerleave",()=>{ if(pressTimer){clearTimeout(pressTimer);pressTimer=null;} });
      td.addEventListener("pointercancel",()=>{ if(pressTimer){clearTimeout(pressTimer);pressTimer=null;} });

      tr.appendChild(td);
    }
    table.appendChild(tr);
  }
  game.innerHTML="";
  game.appendChild(table);
}

function cellEl(r,c){
  return document.querySelector(`td[data-r="${r}"][data-c="${c}"]`);
}
function updateCellView(r,c){
  const td=cellEl(r,c);
  if(!td) return;

  td.className="";
  td.textContent="";

  if(flags[r][c] && !opened[r][c]){
    td.classList.add("flag");
    td.textContent="üö©";
    return;
  }
  if(!opened[r][c]) return;

  if(isAlienCell(r,c)){
    td.classList.add("open","alien");
    return;
  }

  td.classList.add("open");
  const v=board[r][c];
  if(v===-1){ td.classList.add("enemy"); return; }
  if(v===0) return;

  td.textContent=String(v);
  td.classList.add("num"+v);
}
function refreshAll(){
  for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) updateCellView(r,c);
}

/* ===== logic ===== */
function floodOpen(sr,sc){
  const q=[[sr,sc]];
  const seen=new Set([key(sr,sc)]);

  while(q.length){
    const [r,c]=q.shift();
    opened[r][c]=true;
    flags[r][c]=false;
    updateCellView(r,c);

    if(isAlienCell(r,c)) continue;
    if(board[r][c]!==0) continue;

    for(const [nr,nc] of neighbors(r,c)){
      const k=key(nr,nc);
      if(seen.has(k)) continue;
      if(opened[nr][nc]) continue;
      if(flags[nr][nc]) continue;
      if(isAlienCell(nr,nc)) continue;
      seen.add(k);
      q.push([nr,nc]);
    }
  }
}

function openExtraRing(r,c,dist){
  for(let dr=-dist; dr<=dist; dr++){
    for(let dc=-dist; dc<=dist; dc++){
      const nr=r+dr, nc=c+dc;
      if(!inBounds(nr,nc)) continue;
      if(opened[nr][nc]) continue;
      opened[nr][nc]=true;
      updateCellView(nr,nc);
    }
  }
}

function openCell(r,c){
  if(gameOver) return;
  if(flags[r][c]) return;

  if(!started){
    started=true;
    placeEnemiesWithSafeZone(r,c);
  }
  if(opened[r][c]) return;

  play(seOpen);

  if(isAlienCell(r,c)){
    opened[r][c]=true;
    updateCellView(r,c);
    play(alienSound);
    statusEl.textContent="ÁÅ´Êòü‰∫∫„Å†ÔºÅÔºÅÔºÅ";
    checkStagesAndClear();
    return;
  }

  if(board[r][c]===-1){
    gameOver=true;
    explorer.src=IMG_DEATH;
    explorer.classList.add("captured");
    explorer.classList.remove("perfect");
    statusEl.textContent="‰ªªÂãôÂ§±Êïó...!!";
    play(seDeath);

    for(let rr=0; rr<ROWS; rr++){
      for(let cc=0; cc<COLS; cc++){
        if(board[rr][cc]===-1) opened[rr][cc]=true;
      }
    }
    openExtraRing(r,c,EXTRA_RING_OPEN);
    refreshAll();
    ensureBgmPlaying();
    return;
  }

  floodOpen(r,c);
  checkStagesAndClear();
}

function toggleFlag(r,c){
  if(gameOver) return;
  if(opened[r][c]) return;

  flags[r][c]=!flags[r][c];
  usedFlag = usedFlag || flags[r][c];

  play(seFlag);
  updateCellView(r,c);
  checkStagesAndClear();
}

function showHypeOnce(text){
  hypeText.textContent=text;
  hype.classList.add("show");
  setTimeout(()=>hype.classList.remove("show"),900);
}
function setStage(stage){
  game.classList.remove("stage1","stage2","stage3");
  if(stage===1) game.classList.add("stage1");
  if(stage===2) game.classList.add("stage2");
  if(stage===3) game.classList.add("stage3");
}

function checkStagesAndClear(){
  const rem=remainingSafeCells();

  if(rem<=10 && stageShown<1){
    stageShown=1;
    setStage(1);
    explorer.src=IMG_HYPE1;
    statusEl.textContent="Êó©„ÅèÂÆáÂÆôËàπ„Å´Êàª„Çâ„Å™„ÅÑ„Å®...!";
    switchBgmMode(true);
  }

  if(rem<=3 && stageShown<2){
    stageShown=2;
    setStage(2);
    explorer.src=IMG_HYPE2;
    statusEl.textContent="„ÇÇ„ÅÜÂ∞ë„Åó„Å†‚Ä¶ÔºÅ";
  }

  if(rem<=1 && stageShown<3){
    stageShown=3;
    setStage(3);
    explorer.src=IMG_HYPE3;
    statusEl.textContent="Êó©„ÅèËÑ±Âá∫„Åó„Å™„ÅÑ„Å®„Åä„Åâ„Å£„Å£„Å£ÔºÅÔºÅÔºÅ";
    showHypeOnce("Êó©„ÅèËÑ±Âá∫„Åó„Å™„ÅÑ„Å®„Åä„Åâ„Å£„Å£„Å£ÔºÅÔºÅÔºÅ");
  }

  if(rem===0 && !gameOver){
    gameOver=true;

    // „ÇØ„É™„Ç¢„ÅßBGMÂÅúÊ≠¢
    stopAllBgm();

    setStage(0);
    statusEl.classList.add("clear");
    explorer.classList.remove("captured","perfect");

    const isPerfect = !usedFlag;

    if(isPerfect){
      statusEl.textContent="PERFECTÔºÅÔºÅ";
      explorer.src=IMG_PERFECT;

      // ÈáëÊû†
      explorer.classList.add("perfect");

      // ‚òÖË¶ÅÊúõÔºöPERFECTÊôÇ„ÅØ clear2 „ÇíÊµÅ„Åï„Å™„ÅÑ
      // clear1 ‚Üí perfectClear
      play(clear1);
      setTimeout(()=>play(perfectClear), 650);

    }else{
      statusEl.textContent="CLEARÔºÅÔºÅ";
      explorer.src=IMG_CLEAR;

      play(clear1);
      setTimeout(()=>play(clear2),220);
    }
  }
}

function init(){
  lastMode=false;
  ensureBgmPlaying();

  gameOver=false;
  usedFlag=false;
  started=false;
  stageShown=0;
  alienPos=null;

  explorer.src=IMG_NORMAL;
  explorer.classList.remove("captured","perfect");
  statusEl.classList.remove("clear");
  statusEl.textContent="Êé¢Á¥¢ÈñãÂßãÔºÅ";

  board=Array.from({length:ROWS},()=>Array(COLS).fill(0));
  opened=Array.from({length:ROWS},()=>Array(COLS).fill(false));
  flags =Array.from({length:ROWS},()=>Array(COLS).fill(false));

  game.classList.remove("stage1","stage2","stage3");
  render();
  refreshAll();
  setBgmButtonText();
}

init();
</script>
</body>
</html>