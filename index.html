```html
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<title>å®‡å®™æ¢æŸ»ãƒã‚¤ãƒ³ã‚¹ã‚¤ãƒ¼ãƒ‘ãƒ¼</title>

<style>
:root{--cell-size:36px;}
html,body{height:100%; overflow:hidden;}
body{
  margin:0;
  font-family:sans-serif;
  background:url("space.jpg") center/cover no-repeat fixed;
  color:#fff;

  user-select:none;
  -webkit-user-select:none;
  -webkit-touch-callout:none;
  touch-action:manipulation;
}

/* ======================
   ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆPCã¯ãã®ã¾ã¾ï¼‰
====================== */
#container{ display:flex; height:100vh; }

@media(min-width:768px){
  #container{ justify-content:center; align-items:center; gap:32px; }
  :root{--cell-size:48px;}
}

/* ======================
   ã‚¹ãƒãƒ›ã ã‘èª¿æ•´ï¼ˆPCã¯ä¸€åˆ‡ã„ã˜ã‚‰ãªã„ï¼‰
====================== */
@media(max-width:767px){
  :root{--cell-size:min(8.2vw,34px);}

  #container{
    flex-direction:column;
    align-items:center;
    padding-top:56px; /* topButtonsåˆ† */
    gap:8px;
    box-sizing:border-box;
    height:100vh;
  }

  #side{ order:1; width:92vw; padding:8px; }

  /* â˜…ä¸»äººå…¬ç”»åƒã‚’å¤§ããï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‡ºãªã„ã‚®ãƒªã‚®ãƒªå¯„ã‚Šï¼‰ */
  #explorer{
    width:auto;
    max-width:90vw;
    height:28vh;        /* å¤§ãã */
    max-height:260px;   /* å¤§ãã */
    object-fit:contain;
    display:block;
    margin:0 auto;
  }

  #status{ margin-top:6px; font-size:16px; }

  /* ç›¤é¢ãŒã¯ã¿å‡ºãªã„ã‚ˆã†ã«ã ã‘åˆ¶é™ */
  #game{
    order:2;
    width:92vw;
    padding:6px;
    max-height:calc(100vh - 56px - 28vh - 110px);
    overflow:hidden;
  }
}

/* ======================
   ä¸Šéƒ¨ãƒœã‚¿ãƒ³ï¼ˆã‚¹ãƒãƒ›ï¼‰
====================== */
#topButtons{display:none;}
@media(max-width:767px){
  #topButtons{
    position:fixed; top:0; left:0;
    width:100%; height:48px;
    background:rgba(5,5,20,.9);
    display:flex;
    justify-content:center;
    align-items:center;
    gap:12px;
    z-index:999;
    border-bottom:1px solid #111144;
  }
}

/* ======================
   ã‚²ãƒ¼ãƒ ç›¤
====================== */
#game{
  background:rgba(0,0,20,.6);
  border-radius:6px;
  position:relative;
  transition:box-shadow .2s, outline .2s, transform .2s;
}

/* 1æ®µéšç›®ï¼ˆæ®‹ã‚Š10ä»¥ä¸‹ï¼‰ï¼šè–„ã„ç‚¹æ»… */
#game.stage1{ animation:boardStage1 .9s infinite; }
@keyframes boardStage1{
  0%,100%{filter:brightness(.55);}
  50%{filter:brightness(.95);}
}

/* 2æ®µéšç›®ï¼ˆæ®‹ã‚Š3ä»¥ä¸‹ï¼‰ï¼šé»„è‰²æ ãƒã‚«ãƒã‚« */
#game.stage2{
  outline:3px solid rgba(255,215,0,.95);
  box-shadow:0 0 22px rgba(255,215,0,.65);
  animation:stage2Blink .28s infinite;
}
@keyframes stage2Blink{
  0%,100%{filter:brightness(.85) contrast(1.1);}
  50%{filter:brightness(1.35) contrast(1.35);}
}

/* 3æ®µéšç›®ï¼ˆæ®‹ã‚Š1ï¼‰ï¼šèµ¤æ ã§æºã‚Œã‚‹ */
#game.stage3{
  outline:4px solid rgba(255,60,60,.98);
  box-shadow:0 0 34px rgba(255,60,60,.75);
  animation:stage3Shake .16s infinite;
}
@keyframes stage3Shake{
  0%{transform:translate(0,0) rotate(0deg) scale(1.01); filter:brightness(1.05) contrast(1.25);}
  25%{transform:translate(1px,-1px) rotate(-0.4deg) scale(1.02); filter:brightness(1.2) contrast(1.45);}
  50%{transform:translate(-1px,1px) rotate(0.4deg) scale(1.02); filter:brightness(1.35) contrast(1.6);}
  75%{transform:translate(1px,1px) rotate(-0.3deg) scale(1.02); filter:brightness(1.2) contrast(1.45);}
  100%{transform:translate(-1px,-1px) rotate(0.3deg) scale(1.01); filter:brightness(1.05) contrast(1.25);}
}

/* ãƒ©ã‚¹ãƒˆ1ãƒã‚¹ç…½ã‚Šãƒ†ãƒ­ãƒƒãƒ— */
#hype{
  position:fixed; inset:0;
  display:none;
  align-items:center; justify-content:center;
  pointer-events:none;
  z-index:2000;
}
#hype.show{display:flex;}
#hype .box{
  padding:14px 18px;
  background:rgba(0,0,0,.55);
  border:1px solid rgba(255,215,0,.65);
  border-radius:10px;
  color:gold;
  font-weight:900;
  letter-spacing:.08em;
  text-shadow:0 0 10px rgba(255,215,0,.75);
  animation:hypeInOut .9s ease-in-out;
}
@keyframes hypeInOut{
  0%{opacity:0; transform:translateY(10px) scale(.96);}
  25%{opacity:1; transform:translateY(0) scale(1);}
  100%{opacity:0; transform:translateY(-6px) scale(1.02);}
}

table{border-collapse:collapse; margin:auto;}
td{
  width:var(--cell-size);
  height:var(--cell-size);
  border:1px solid #111144;
  background:#1a1a3d;
  text-align:center;
  font-weight:bold;
  cursor:pointer;
  font-size:calc(var(--cell-size)*0.5);

  user-select:none;
  -webkit-user-select:none;
  -webkit-touch-callout:none;

  touch-action:manipulation;
}
td.open{background:#33334d;cursor:default;}
td.flag{background:#111144;color:#0f0;}
td.enemy{background:black url("asteroid.jpeg") center/cover no-repeat;}
td.alien{background:url("alien.jpeg") center/cover no-repeat;}

.num1{color:#66ccff;}
.num2{color:#33ff77;}
.num3{color:#ff6666;}
.num4{color:#cc66ff;}
.num5{color:#ffcc66;}
.num6{color:#00cccc;}
.num7{color:#aaaaaa;}
.num8{color:#ffffff;}

/* ======================
   ã‚µã‚¤ãƒ‰UI
====================== */
#side{
  background:rgba(5,5,20,.7);
  padding:12px;
  text-align:center;
  border-radius:8px;
}
#explorer{width:min(300px,90vw);}
#explorer.captured{filter:grayscale(40%) brightness(.8);}
#explorer.perfect{
  border:6px solid gold;
  border-radius:14px;
  box-shadow:0 0 30px gold;
}

#status{
  margin-top:8px;
  font-size:18px;
  font-weight:bold;
}
#status.clear{
  color:gold;
  text-shadow:0 0 8px gold;
}

/* ======================
   ãƒœã‚¿ãƒ³
====================== */
button{
  padding:8px 14px;
  font-size:14px;
  background:#1a1a3d;
  border:none;
  color:white;
  cursor:pointer;
}
#buttons{
  margin-top:8px;
  display:flex;
  gap:8px;
  justify-content:center;
}
@media(max-width:767px){
  #buttons{display:none;}
}
</style>
</head>

<body>
<div id="topButtons">
  <button id="restartTop">RESTART</button>
  <button id="bgmToggleTop">BGM OFF</button>
</div>

<div id="hype"><div class="box" id="hypeText"></div></div>

<div id="container">
  <div id="game"></div>

  <div id="side">
    <img id="explorer" src="explorer.jpeg" alt="explorer" />
    <div id="status">æ¢ç´¢é–‹å§‹ï¼</div>

    <div id="buttons">
      <button id="restart">RESTART</button>
      <button id="bgmToggle">BGM OFF</button>
    </div>
  </div>
</div>

<!-- AUDIO -->
<audio id="seOpen" src="open.mp3"></audio>
<audio id="seFlag" src="flag.mp3"></audio>
<audio id="seDeath" src="death.mp3"></audio>
<audio id="sePerfect" src="perfect.mp3"></audio>
<audio id="alienSound" src="alienSound.mp3"></audio>
<audio id="clear1" src="clear1.mp3"></audio>
<audio id="clear2" src="clear2.mp3"></audio>
<audio id="bgm" src="bgm.mp3" loop></audio>
<audio id="lastBgm" src="last.mp3" loop></audio>

<script>
/* =========================
   ä»•æ§˜ã¾ã¨ã‚ï¼ˆè¦æœ›åæ˜ ï¼‰
   - PCã¯è§¦ã‚‰ãªã„ï¼ˆCSSå¤‰æ›´ã¯max-width:767pxå†…ã®ã¿ï¼‰
   - ã‚¹ãƒãƒ›ã¯ã€Œä¸€åº¦ã‚¿ãƒƒãƒ—ã—ãŸã‚‰ã€BGMãŒé³´ã‚Šç¶šã‘ã‚‹ï¼š
     çˆ†å¼¾ã§æ­»äº¡â†’RESTARTã—ã¦ã‚‚æ­¢ã‚ãªã„
   - æ®‹ã‚Š10ä»¥ä¸‹ã§ lastBgm ã«åˆ‡ã‚Šæ›¿ãˆã¯ã™ã‚‹ãŒã€é³´ã‚Šç¶šã‘ã‚‹ï¼ˆæ­¢ã‚ãªã„ï¼‰
   - ã‚¯ãƒªã‚¢æ™‚ã¯ lastBgmï¼ˆæ™‚è¨ˆéŸ³ãªã©ï¼‰ã ã‘æ­¢ã‚ã‚‹ï¼ˆå‰è¦æœ›ç¶­æŒï¼‰
   - å®‡å®™äººã¯ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã ã‘å‡ºã‚‹ï¼ˆ0é€£é–ã§å‹æ‰‹ã«é–‹ã‹ãªã„ï¼‰
   - æœ€å¾Œã®1ãƒã‚¹ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼šæ—©ãè„±å‡ºã—ãªã„ã¨ãŠã‰ã£ã£ã£ï¼ï¼ï¼
========================= */

const ROWS=9, COLS=9, ENEMIES=10;

const IMG_NORMAL   = "explorer.jpeg";
const IMG_HYPE1    = "hype1.jpeg";
const IMG_HYPE2    = "hype2.jpeg";
const IMG_HYPE3    = "hype3.jpeg";
const IMG_CLEAR    = "clear.jpeg";
const IMG_PERFECT  = "perfect.jpeg";
const IMG_DEATH    = "explorer.jpeg";

const EXTRA_RING_OPEN = 3;

let board=[], opened=[], flags=[];
let gameOver=false;
let usedFlag=false;
let started=false;

let lastMode=false;
let stageShown=0;

let alienPos=null;
let alienFound=false;

const game=document.getElementById("game");
const explorer=document.getElementById("explorer");
const statusEl=document.getElementById("status");
const hype=document.getElementById("hype");
const hypeText=document.getElementById("hypeText");

const bgm=document.getElementById("bgm");
const lastBgm=document.getElementById("lastBgm");

const bgmToggle=document.getElementById("bgmToggle");
const bgmToggleTop=document.getElementById("bgmToggleTop");

const seOpen=document.getElementById("seOpen");
const seFlag=document.getElementById("seFlag");
const seDeath=document.getElementById("seDeath");
const sePerfect=document.getElementById("sePerfect");
const alienSound=document.getElementById("alienSound");
const clear1=document.getElementById("clear1");
const clear2=document.getElementById("clear2");

/* ===== BGM æ°¸ç¶šï¼ˆã‚¹ãƒãƒ›ã§ä¸€åº¦é³´ã‚‰ã—ãŸã‚‰ãƒªã‚¹ã‚¿ãƒ¼ãƒˆã§ã‚‚ç¶™ç¶šï¼‰ ===== */
let bgmUnlocked=false;      // æœ€åˆã®ã‚¿ãƒƒãƒ—ã§true
let userBgmEnabled=true;    // ãƒœã‚¿ãƒ³ã§OFFã«ã—ãŸã‚‰false

function play(se){
  if(!se) return;
  try{ se.currentTime=0; se.play().catch(()=>{}); }catch(e){}
}

function isAnyBgmPlaying(){ return (!bgm.paused) || (!lastBgm.paused); }
function setBgmButtonText(){
  const on = userBgmEnabled && bgmUnlocked;
  const t = on ? "BGM OFF" : "BGM ON";
  bgmToggle.textContent=t;
  bgmToggleTop.textContent=t;
}

function currentBgmEl(){
  return lastMode ? lastBgm : bgm;
}

function stopAllBgmHard(){
  bgm.pause(); lastBgm.pause();
}

function ensureBgmPlaying(){
  if(!bgmUnlocked) return;
  if(!userBgmEnabled) return;
  // ã„ã¾é³´ã‚‰ã™ã¹ãBGMã‚’é³´ã‚‰ã™ï¼ˆæ—¢ã«é³´ã£ã¦ã‚Œã°è§¦ã‚‰ãªã„ï¼‰
  const target = currentBgmEl();
  if(!target.paused) return;
  // ã‚‚ã†ç‰‡æ–¹ãŒé³´ã£ã¦ã„ãŸã‚‰æ­¢ã‚ã‚‹
  if(target === bgm && !lastBgm.paused) lastBgm.pause();
  if(target === lastBgm && !bgm.paused) bgm.pause();

  target.play().catch(()=>{ /* è‡ªå‹•å†ç”Ÿåˆ¶é™æ™‚ã¯ç„¡è¦– */ });
}

function toggleBGM(){
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ„æ€ã§ON/OFFã‚’ç¶­æŒ
  userBgmEnabled = !userBgmEnabled;
  if(!userBgmEnabled){
    stopAllBgmHard();
  }else{
    ensureBgmPlaying();
  }
  setBgmButtonText();
}
bgmToggle.onclick=toggleBGM;
bgmToggleTop.onclick=toggleBGM;

/* ã‚¹ãƒãƒ›è‡ªå‹•å†ç”Ÿåˆ¶é™å¯¾ç­–ï¼šæœ€åˆã®ã‚¿ãƒƒãƒ—ã§ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã—ã¦ã€ä»¥é™ã¯ãšã£ã¨ç¶™ç¶š */
document.addEventListener("pointerdown", ()=>{
  bgmUnlocked=true;
  setBgmButtonText();
  ensureBgmPlaying();
},{once:true});

/* æ®‹ã‚Š10ä»¥ä¸‹ã§lastBgmã¸åˆ‡æ›¿ï¼ˆé³´ã£ã¦ã„ã‚‹/é³´ã£ã¦ã„ãªã„ã«é–¢ã‚ã‚‰ãšã€ŒçŠ¶æ…‹ã€ã‚’ç¶­æŒã—ã¦å†ç”Ÿï¼‰ */
function switchBgmMode(toLast){
  if(lastMode === toLast) return;
  lastMode = toLast;
  // ã€Œä¸€åº¦ã‚¿ãƒƒãƒ—ã—ãŸã‚‰æµã‚Œç¶šã‘ã‚‹ã€æ–¹é‡ãªã®ã§ã€æ¡ä»¶ã‚’æº€ãŸã™ãªã‚‰ç¢ºå®Ÿã«é³´ã‚‰ã™
  ensureBgmPlaying();
}

/* ã‚¯ãƒªã‚¢æ™‚ï¼šæ™‚è¨ˆéŸ³(lastBgm)ã ã‘ã¯æ­¢ã‚ã‚‹ï¼ˆå‰è¦æœ›ï¼‰ */
function stopHypeBgmOnClear(){
  if(!lastBgm.paused) lastBgm.pause();
  // é€šå¸¸BGMã«æˆ»ã™ï¼ˆãŸã ã—ãƒ¦ãƒ¼ã‚¶ãƒ¼OFFãªã‚‰æˆ»ã•ãªã„ï¼‰
  lastMode=false;
  ensureBgmPlaying();
}

/* å³ã‚¯ãƒªãƒƒã‚¯/é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼æŠ‘æ­¢ */
document.addEventListener("contextmenu", (e)=>e.preventDefault());

document.getElementById("restart").onclick=init;
document.getElementById("restartTop").onclick=init;

/* ===== util ===== */
function inBounds(r,c){ return r>=0 && r<ROWS && c>=0 && c<COLS; }
function neighbors(r,c){
  const res=[];
  for(let dr=-1; dr<=1; dr++){
    for(let dc=-1; dc<=1; dc++){
      if(dr===0 && dc===0) continue;
      const nr=r+dr, nc=c+dc;
      if(inBounds(nr,nc)) res.push([nr,nc]);
    }
  }
  return res;
}
function countAdjEnemies(r,c){
  return neighbors(r,c).reduce((acc,[nr,nc])=>acc + (board[nr][nc]===-1 ? 1 : 0),0);
}
function computeNumbers(){
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(board[r][c]===-1) continue;
      board[r][c]=countAdjEnemies(r,c);
    }
  }
}
function remainingSafeCells(){
  let cnt=0;
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(board[r][c]!==-1 && !opened[r][c]) cnt++;
    }
  }
  return cnt;
}
function key(r,c){ return r+","+c; }
function isAlienCell(r,c){
  return alienPos && alienPos[0]===r && alienPos[1]===c;
}

/* ===== board ===== */
function placeEnemiesWithSafeZone(excludeR, excludeC){
  board = Array.from({length:ROWS},()=>Array(COLS).fill(0));

  const safe=new Set();
  safe.add(key(excludeR,excludeC));
  for(const [nr,nc] of neighbors(excludeR, excludeC)) safe.add(key(nr,nc));

  let placed=0;
  while(placed<ENEMIES){
    const r=Math.floor(Math.random()*ROWS);
    const c=Math.floor(Math.random()*COLS);
    if(safe.has(key(r,c))) continue;
    if(board[r][c]===-1) continue;
    board[r][c]=-1;
    placed++;
  }

  // å®‡å®™äººï¼ˆå®‰å…¨ãƒã‚¹ï¼‰ã‚’1ä½“é…ç½®ï¼šåœ°é›·ã§ã¯ãªã„ï¼†å®‰å…¨åœ°å¸¯ã«ã‚‚ç½®ã‹ãªã„
  alienPos=null;
  alienFound=false;
  while(true){
    const r=Math.floor(Math.random()*ROWS);
    const c=Math.floor(Math.random()*COLS);
    if(safe.has(key(r,c))) continue;
    if(board[r][c]===-1) continue;
    alienPos=[r,c];
    break;
  }

  computeNumbers();
}

/* ===== render ===== */
function cellEl(r,c){
  return document.querySelector(`td[data-r="${r}"][data-c="${c}"]`);
}

function render(){
  const table=document.createElement("table");
  for(let r=0;r<ROWS;r++){
    const tr=document.createElement("tr");
    for(let c=0;c<COLS;c++){
      const td=document.createElement("td");
      td.dataset.r=r; td.dataset.c=c;

      td.addEventListener("click", (e)=>{
        e.preventDefault();
        if(gameOver) return;
        openCell(r,c);
      });

      td.addEventListener("contextmenu", (e)=>{
        e.preventDefault();
        if(gameOver) return;
        toggleFlag(r,c);
      });

      // ã‚¹ãƒãƒ›é•·æŠ¼ã—æ——
      let pressTimer=null;
      td.addEventListener("pointerdown", (e)=>{
        if(e.pointerType === "mouse") return;
        if(gameOver) return;
        pressTimer=setTimeout(()=>{
          toggleFlag(r,c);
          pressTimer=null;
        }, 380);
      });
      td.addEventListener("pointerup", ()=>{ if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; } });
      td.addEventListener("pointerleave", ()=>{ if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; } });
      td.addEventListener("pointercancel", ()=>{ if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; } });

      tr.appendChild(td);
    }
    table.appendChild(tr);
  }
  game.innerHTML="";
  game.appendChild(table);
}

function updateCellView(r,c){
  const td=cellEl(r,c);
  if(!td) return;

  td.className="";
  td.textContent="";

  if(flags[r][c] && !opened[r][c]){
    td.classList.add("flag");
    td.textContent="ğŸš©";
    return;
  }

  if(!opened[r][c]) return;

  if(isAlienCell(r,c)){
    td.classList.add("open","alien");
    td.textContent="";
    return;
  }

  td.classList.add("open");
  const v=board[r][c];

  if(v===-1){
    td.classList.add("enemy");
    td.textContent="";
    return;
  }
  if(v===0){
    td.textContent="";
    return;
  }
  td.textContent=String(v);
  td.classList.add("num"+v);
}
function refreshAll(){
  for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) updateCellView(r,c);
}

/* ===== game logic ===== */
function floodOpen(sr,sc){
  const q=[[sr,sc]];
  const seen=new Set([key(sr,sc)]);

  while(q.length){
    const [r,c]=q.shift();
    opened[r][c]=true;
    flags[r][c]=false;
    updateCellView(r,c);

    if(isAlienCell(r,c)) continue;
    if(board[r][c]!==0) continue;

    for(const [nr,nc] of neighbors(r,c)){
      const k=key(nr,nc);
      if(seen.has(k)) continue;
      if(opened[nr][nc]) continue;
      if(flags[nr][nc]) continue;

      // å®‡å®™äººãƒã‚¹ã¯é€£é–ã§é–‹ã‹ãªã„ï¼ˆã‚¯ãƒªãƒƒã‚¯å¿…é ˆï¼‰
      if(isAlienCell(nr,nc)) continue;

      seen.add(k);
      q.push([nr,nc]);
    }
  }
}

function openExtraRing(r,c,dist){
  for(let dr=-dist; dr<=dist; dr++){
    for(let dc=-dist; dc<=dist; dc++){
      const nr=r+dr, nc=c+dc;
      if(!inBounds(nr,nc)) continue;
      if(opened[nr][nc]) continue;
      opened[nr][nc]=true;
      updateCellView(nr,nc);
    }
  }
}

function openCell(r,c){
  if(gameOver) return;
  if(flags[r][c]) return;

  if(!started){
    started=true;
    placeEnemiesWithSafeZone(r,c);
  }

  if(opened[r][c]) return;

  play(seOpen);

  // å®‡å®™äººï¼šãã®ãƒã‚¹ã‚’ç›´æ¥ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã ã‘
  if(isAlienCell(r,c)){
    opened[r][c]=true;
    alienFound=true;
    updateCellView(r,c);
    play(alienSound);
    statusEl.textContent="å®‡å®™äººã ï¼ï¼ï¼";
    checkStagesAndClear();
    return;
  }

  if(board[r][c]===-1){
    gameOver=true;
    explorer.src = IMG_DEATH;
    explorer.classList.add("captured");
    statusEl.textContent="æ’ƒæ²ˆâ€¦ï¼";
    play(seDeath);

    for(let rr=0; rr<ROWS; rr++){
      for(let cc=0; cc<COLS; cc++){
        if(board[rr][cc]===-1) opened[rr][cc]=true;
      }
    }
    openExtraRing(r,c,EXTRA_RING_OPEN);
    refreshAll();

    // â˜…æ­»äº¡ã—ã¦ã‚‚BGMã¯æ­¢ã‚ãªã„ï¼ˆè¦æœ›ï¼‰
    ensureBgmPlaying();
    return;
  }

  floodOpen(r,c);
  checkStagesAndClear();
}

function toggleFlag(r,c){
  if(gameOver) return;
  if(opened[r][c]) return;

  flags[r][c]=!flags[r][c];
  usedFlag = usedFlag || flags[r][c];

  play(seFlag);
  updateCellView(r,c);
  checkStagesAndClear();
}

function showHypeOnce(text){
  hypeText.textContent=text;
  hype.classList.add("show");
  setTimeout(()=>hype.classList.remove("show"), 900);
}

function setStage(stage){
  game.classList.remove("stage1","stage2","stage3");
  if(stage===1) game.classList.add("stage1");
  if(stage===2) game.classList.add("stage2");
  if(stage===3) game.classList.add("stage3");
}

function checkStagesAndClear(){
  const rem = remainingSafeCells();

  if(rem<=10 && stageShown<1){
    stageShown=1;
    setStage(1);
    explorer.src = IMG_HYPE1;
    statusEl.textContent="æ—©ãå®‡å®™èˆ¹ã«æˆ»ã‚‰ãªã„ã¨...!";
    switchBgmMode(true);
  }

  if(rem<=3 && stageShown<2){
    stageShown=2;
    setStage(2);
    explorer.src = IMG_HYPE2;
    statusEl.textContent="ã‚‚ã†å°‘ã—ã â€¦ï¼";
  }

  if(rem<=1 && stageShown<3){
    stageShown=3;
    setStage(3);
    explorer.src = IMG_HYPE3;
    statusEl.textContent="æ—©ãè„±å‡ºã—ãªã„ã¨ãŠã‰ã£ã£ã£ï¼ï¼ï¼";
    showHypeOnce("æ—©ãè„±å‡ºã—ãªã„ã¨ãŠã‰ã£ã£ã£ï¼ï¼ï¼");
  }

  if(rem===0 && !gameOver){
    gameOver=true;

    // ã‚¯ãƒªã‚¢å¾Œã«æ™‚è¨ˆéŸ³ãŒé³´ã‚Šç¶šã‘ãªã„
    stopHypeBgmOnClear();

    setStage(0);

    statusEl.classList.add("clear");
    explorer.classList.remove("captured");
    explorer.classList.remove("perfect");

    if(!usedFlag){
      statusEl.textContent="PERFECTï¼ï¼";
      explorer.src = IMG_PERFECT;
      explorer.classList.add("perfect");
      play(sePerfect);
    }else{
      statusEl.textContent="CLEARï¼ï¼";
      explorer.src = IMG_CLEAR;
      play(clear1);
      setTimeout(()=>play(clear2), 220);
    }
  }
}

function init(){
  // â˜…RESTARTã—ã¦ã‚‚BGMã¯æ­¢ã‚ãªã„ï¼ˆè¦æœ›ï¼‰
  // lastModeã¯ã‚²ãƒ¼ãƒ æ¼”å‡ºã®çŠ¶æ…‹ã ã‘åˆæœŸåŒ–ï¼ˆãŸã ã—BGMè‡ªä½“ã¯ ensureBgmPlaying ãŒç¶™ç¶šã•ã›ã‚‹ï¼‰
  lastMode=false;
  ensureBgmPlaying();

  gameOver=false;
  usedFlag=false;
  started=false;
  stageShown=0;

  alienPos=null;
  alienFound=false;

  explorer.src = IMG_NORMAL;
  explorer.classList.remove("captured","perfect");
  statusEl.classList.remove("clear");
  statusEl.textContent="æ¢ç´¢é–‹å§‹ï¼";

  board = Array.from({length:ROWS},()=>Array(COLS).fill(0));
  opened = Array.from({length:ROWS},()=>Array(COLS).fill(false));
  flags  = Array.from({length:ROWS},()=>Array(COLS).fill(false));

  game.classList.remove("stage1","stage2","stage3");

  render();
  refreshAll();
  setBgmButtonText();
}

init();
</script>
</body>
</html>
```