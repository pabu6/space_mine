<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÂÆáÂÆôÊé¢Êüª„Éû„Ç§„É≥„Çπ„Ç§„Éº„Éë„Éº</title>

<style>
:root{--cell-size:36px;}
body{
  margin:0;
  font-family:sans-serif;
  background:url("space.jpg") center/cover no-repeat fixed;
  color:#fff;
  user-select:none;
}
#container{display:flex;min-height:100vh;}

@media(min-width:768px){
  #container{justify-content:center;align-items:center;gap:32px;}
  :root{--cell-size:48px;}
}
@media(max-width:767px){
  :root{--cell-size:min(9vw,38px);}
  #container{flex-direction:column;align-items:center;}
  #explorer{width:26vw;}
  #game{width:90vw;}
}

#game{
  padding:10px;
  background:rgba(0,0,20,.6);
  border-radius:6px;
  position:relative;
}
#game.last-flash{animation:boardFlash .9s infinite;}
@keyframes boardFlash{
  0%,100%{filter:brightness(.55);}
  50%{filter:brightness(.9);}
}

table{border-collapse:collapse;}
td{
  width:var(--cell-size);
  height:var(--cell-size);
  border:1px solid #111144;
  background:#1a1a3d;
  text-align:center;
  font-weight:bold;
  cursor:pointer;
  font-size:calc(var(--cell-size)*0.5);
}
td.open{background:#33334d;cursor:default;}
td.flag{background:#111144;color:#0f0;}
td.enemy{background:black url("asteroid.jpeg") center/cover no-repeat;}
td.alien{background:url("alien.jpeg") center/cover no-repeat;}

.num1{color:#66ccff;}
.num2{color:#33ff77;}
.num3{color:#ff6666;}
.num4{color:#cc66ff;}
.num5{color:#ffcc66;}
.num6{color:#00cccc;}
.num7{color:#aaaaaa;}
.num8{color:#ffffff;}

#side{
  background:rgba(5,5,20,.7);
  padding:12px;
  text-align:center;
  border-radius:8px;
}
#explorer{width:min(300px,90vw);}
#explorer.captured{filter:grayscale(40%) brightness(.8);}
#explorer.perfect{
  border:6px solid gold;
  border-radius:14px;
  box-shadow:0 0 30px gold;
}

#status{margin-top:8px;font-size:18px;font-weight:bold;}
#status.clear{color:gold;text-shadow:0 0 8px gold;}

#buttons{
  margin-top:8px;
  display:flex;
  gap:8px;
  justify-content:center;
}
button{
  padding:8px 14px;
  font-size:14px;
  background:#1a1a3d;
  border:none;
  color:white;
  cursor:pointer;
}
</style>
</head>

<body>
<div id="container">
  <div id="game"></div>

  <div id="side">
    <img id="explorer" src="explorer.jpeg">
    <div id="status">Êé¢Á¥¢ÈñãÂßãÔºÅ</div>
    <div id="buttons">
      <button id="restart">RESTART</button>
      <button id="bgmToggle">BGM OFF</button>
    </div>
  </div>
</div>

<!-- AUDIO -->
<audio id="seOpen" src="open.mp3"></audio>
<audio id="seFlag" src="flag.mp3"></audio>
<audio id="seDeath" src="death.mp3"></audio>
<audio id="sePerfect" src="perfect.mp3"></audio>
<audio id="alienSound" src="alienSound.mp3"></audio>
<audio id="clear1" src="clear1.mp3"></audio>
<audio id="clear2" src="clear2.mp3"></audio>
<audio id="bgm" src="bgm.mp3" loop></audio>
<audio id="lastBgm" src="last.mp3" loop></audio>

<script>
const ROWS=9, COLS=9, ENEMIES=10;
let board=[],opened=[],flags=[];
let gameOver=false,lastMode=false,usedFlag=false;

const game=document.getElementById("game");
const explorer=document.getElementById("explorer");
const status=document.getElementById("status");

const bgm=document.getElementById("bgm");
const lastBgm=document.getElementById("lastBgm");
const bgmToggle=document.getElementById("bgmToggle");

const seOpen=document.getElementById("seOpen");
const seFlag=document.getElementById("seFlag");
const seDeath=document.getElementById("seDeath");
const sePerfect=document.getElementById("sePerfect");
const alienSound=document.getElementById("alienSound");
const clear1=document.getElementById("clear1");
const clear2=document.getElementById("clear2");

function play(se){se.currentTime=0;se.play().catch(()=>{});}

bgmToggle.onclick=()=>{
  if(!bgm.paused||!lastBgm.paused){
    bgm.pause(); lastBgm.pause();
    bgmToggle.textContent="BGM ON";
  }else{
    bgm.play().catch(()=>{});
    bgmToggle.textContent="BGM OFF";
  }
};

document.getElementById("restart").onclick=init;

function init(){
  board=Array.from({length:ROWS},()=>Array(COLS).fill(0));
  opened=Array.from({length:ROWS},()=>Array(COLS).fill(false));
  flags=Array.from({length:ROWS},()=>Array(COLS).fill(false));
  gameOver=false;lastMode=false;usedFlag=false;

  game.classList.remove("last-flash");
  explorer.src="explorer.jpeg";
  explorer.className="";
  status.textContent="Êé¢Á¥¢ÈñãÂßãÔºÅ";
  status.classList.remove("clear");

  let placed=0;
  while(placed<ENEMIES){
    let r=Math.random()*ROWS|0,c=Math.random()*COLS|0;
    if(board[r][c]!=="E"){board[r][c]="E";placed++;}
  }

  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
    if(board[r][c]==="E")continue;
    let n=0;
    for(let dr=-1;dr<=1;dr++)for(let dc=-1;dc<=1;dc++){
      let nr=r+dr,nc=c+dc;
      if(nr>=0&&nr<ROWS&&nc>=0&&nc<COLS&&board[nr][nc]==="E")n++;
    }
    board[r][c]=n;
  }

  const zeros=[];
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
    if(board[r][c]===0) zeros.push([r,c]);
  }
  if(zeros.length){
    const [ar,ac]=zeros[Math.random()*zeros.length|0];
    board[ar][ac]="A";
  }

  bgm.currentTime=0;
  bgm.play().catch(()=>{});
  bgmToggle.textContent="BGM OFF";

  draw();
}

function draw(){
  game.innerHTML="";
  const table=document.createElement("table");

  for(let r=0;r<ROWS;r++){
    const tr=document.createElement("tr");
    for(let c=0;c<COLS;c++){
      const td=document.createElement("td");

      if(opened[r][c]){
        td.classList.add("open");
        if(board[r][c]==="E") td.classList.add("enemy");
        else if(board[r][c]==="A") td.classList.add("alien");
        else if(board[r][c]>0){
          td.textContent=board[r][c];
          td.classList.add("num"+board[r][c]);
        }
      }else if(flags[r][c]){
        td.classList.add("flag");
        td.textContent="üö©";
      }

      td.onclick=()=>{
        if(gameOver||flags[r][c])return;
        openCell(r,c);
        draw();
      };

      td.oncontextmenu=e=>{
        e.preventDefault();
        flags[r][c]=!flags[r][c];
        usedFlag=true;
        play(seFlag);
        draw();
      };

      tr.appendChild(td);
    }
    table.appendChild(tr);
  }
  game.appendChild(table);
}

function openCell(r,c){
  if(opened[r][c])return;

  if(board[r][c]==="A"){
    opened[r][c]=true;
    play(alienSound);
    checkClear();
    return;
  }

  opened[r][c]=true;

  if(board[r][c]==="E"){
    gameOver=true;
    play(seDeath);
    bgm.pause(); lastBgm.pause();
    explorer.src="explorer_captured.jpeg";
    explorer.classList.add("captured");
    return;
  }

  play(seOpen);

  if(board[r][c]===0){
    for(let dx=-1;dx<=1;dx++)for(let dy=-1;dy<=1;dy++){
      const nx=r+dx,ny=c+dy;
      if(nx>=0&&nx<ROWS&&ny>=0&&ny<COLS&&!opened[nx][ny]){
        if(board[nx][ny]!=="A") openCell(nx,ny);
      }
    }
  }

  checkLastOne();
  checkClear();
}

function checkLastOne(){
  let safe=ROWS*COLS-ENEMIES;
  let openedSafe=0;
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
    if(opened[r][c] && board[r][c]!=="E") openedSafe++;
  }
  if(safe-openedSafe===1 && !lastMode){
    lastMode=true;
    game.classList.add("last-flash");
    bgm.pause();
    lastBgm.currentTime=0;
    lastBgm.play().catch(()=>{});
  }
}

function checkClear(){
  let safe=ROWS*COLS-ENEMIES;
  let openedSafe=0;
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
    if(opened[r][c] && board[r][c]!=="E") openedSafe++;
  }

  if(openedSafe===safe){
    gameOver=true;
    bgm.pause(); lastBgm.pause();
    status.textContent="CONGRATULATIONS!!";
    status.classList.add("clear");

    clear1.currentTime=0;
    clear1.play();
    clear1.onended=()=>{
      clear2.currentTime=0;
      clear2.play();
    };

    if(!usedFlag){
      explorer.src="explorer_perfect.jpeg";
      explorer.classList.add("perfect");
      play(sePerfect);
    }else{
      explorer.src="explorer_clear.jpeg";
    }
  }
}

init();
</script>
</body>
</html>
